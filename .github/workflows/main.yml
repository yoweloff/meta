name: Android CI

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /usr/lib/jvm/temurin-17-jdk-amd64

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ Gradle (~30% —É—Å–∫–æ—Ä–µ–Ω–∏–µ —Å–±–æ—Ä–∫–∏)
    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle-wrapper.properties') }}

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π gradlew (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å) –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π
    - name: Set up Gradle Wrapper
      run: |
        if [ -f "gradlew" ]; then
          echo "‚úÖ gradlew —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ø—Ä–æ–µ–∫—Ç–µ"
        else
          echo "‚öôÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Gradle Wrapper..."
          gradle wrapper --gradle-version 8.2 --distribution-type bin
        fi
        chmod +x gradlew

    - name: Clean project
      run: ./gradlew clean

    # –§–∏–∫—Å –¥–ª—è AndroidManifest.xml (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
    - name: Fix AndroidManifest.xml
      run: |
        if [ -f "app/src/main/AndroidManifest.xml" ]; then
          if ! grep -q 'android:exported=' app/src/main/AndroidManifest.xml; then
            sed -i '/<activity.*android:name=".MainActivity"/a \        android:exported="true"' app/src/main/AndroidManifest.xml
            echo "üõ† –î–æ–±–∞–≤–ª–µ–Ω android:exported –≤ MainActivity"
          fi
        else
          echo "‚ö†Ô∏è –§–∞–π–ª AndroidManifest.xml –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        fi

    - name: Build APK
      run: |
        ./gradlew assembleDebug --stacktrace --info

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug
        path: app/build/outputs/apk/debug/app-debug.apk
        retention-days: 3
